<html>
<head>
	<meta charset="UTF-8">
	<title>The Game of Squava</title>
<style>
table.fixed { table-layout:fixed; }
table.fixed td { overflow: hidden; }
</style>

<script language="javascript">
var board = new Array(5);
for (var i = 0; i < 5; ++i) {
	board[i] = new Array(5);
	for (var j = 0; j < 5; ++j) {
		board[i][j] = 0;
	}
}
var game_over = false;
var WIN = 1000;
var LOSS = -1000;
var max_depth = 6;
var move_counter = 0;

function clork(o, n, m) {
	if (game_over) { return; }
	var td = o.parentNode;
	td.innerHTML = 'X';
	board[n][m] = -1;
	color_winner();
	++move_counter;
	mymove();
}

function mymove() {
	if (game_over) { return; }

	if (move_counter < 8)  { max_depth = 4; }
	if (move_counter > 7)  { max_depth = 6; }
	if (move_counter > 12) { max_depth = 8; }

	var max = LOSS;
	var moves = new Array(25);
	for (var i = 0; i < 25; ++i) {
		moves[i] = new Array(2);
	}
	var next = 0;

	for (var i = 0; i < 5; ++i) {
		for (var j = 0; j < 5; ++j) {
			if (board[i][j] == 0) {

				board[i][j] = 1;
				var val = alphabeta(1, -1, LOSS, WIN);
				board[i][j] = 0;

				if (val >= max) {
					if (val > max) {
						max = val;
						next = 0;
					}
					moves[next][0] = i;
					moves[next][1] = j;
					++next;
				}
			}
		}
	}
	var r = Math.floor(Math.random()*next);
	var p = moves[r][0];
	var q = moves[r][1];
	document.getElementById('td'+p+q).innerHTML = 'O';
	board[p][q] = 1;
	color_winner();
	++move_counter;
}

function color_winner() {
	var we = check_winner();
	if (we[1]) {
		game_over = true;
		// Find winning quad, color it green
		for (var idx in winning_quads) {
				var quad = winning_quads[idx];
				var sum = board[quad[0][0]][quad[0][1]];
				sum += board[quad[1][0]][quad[1][1]];
				sum += board[quad[2][0]][quad[2][1]];
				sum += board[quad[3][0]][quad[3][1]];

				if (sum == 4 || sum == -4) {
					for (var j in quad) {
						var td = document.getElementById(
							'td'+quad[j][0]+quad[j][1]
						);
						td.style.backgroundColor = "#00FF00";
					}
					return;
				}
		}
		// Find losing triplet, color it red.
		for (var idx in losing_triplets) {
			var triplet = losing_triplets[idx];
			var sum = board[triplet[0][0]][triplet[0][1]];
			sum += board[triplet[1][0]][triplet[1][1]];
			sum += board[triplet[2][0]][triplet[2][1]];

			if (sum == 3 || sum == -3) {
				for (var j in triplet) {
					var td = document.getElementById(
						'td'+triplet[j][0]+triplet[j][1]
					);
					td.style.backgroundColor = "red";
				}
				return;
			}
		}
		// Find winning quad, color it green
	}
}

function alphabeta(ply, player, alpha, beta) {
	var we = check_winner();
	if (we[1]) {
		switch (we[0]) {
		case 1:
			return WIN - ply;
			break;
		case -1:
			return LOSS + ply;
			break;
		case 0:
			return 0;
			break;
		}
	}
	if (ply == max_depth) {
		return static_value();
	}
	var value;
	switch (player) {
	case 1:
		value = LOSS;
		for (var i = 0; i < 5; ++i) {
			for (var j = 0; j < 5; ++j) {
				var marker = board[i][j];
				if (marker == 0) {
					board[i][j] = player;
					n = alphabeta(ply+1, -player, alpha, beta);
					board[i][j] = 0;
					if (n > value) {
						value = n;
					}
					if (value > alpha) {
						alpha = value;
					}
					if (beta <= alpha) {
						return value;
					}
				}
			}
		}
	break;
	case -1:
		value = WIN

		for (var i = 0; i < 5; ++i) {
			for (var j = 0; j < 5; ++j) {
				var marker = board[i][j];
				if (marker == 0) {
					board[i][j] = player;
					n = alphabeta(ply+1, -player, alpha, beta);
					board[i][j] = 0;
					if (n < value) {
						value = n;
					}
					if (value < beta) {
						beta = value;
					}
					if (beta <= alpha) {
						return value;
					}
				}
			}
		}
		break;
	}
	return value;
}

var scores = [
    [3, 2, 2, 2, 3],
    [2, 2, 1, 2, 2],
    [2, 1, 0, 1, 2],
    [2, 2, 1, 2, 1],
    [3, 2, 2, 2, 3]
];

var losing_triplets = [
	[[0, 0], [1, 0], [2, 0]],
	[[0, 0], [0, 1], [0, 2]],
	[[0, 0], [1, 1], [2, 2]],
	[[1, 0], [2, 0], [3, 0]],
	[[1, 0], [1, 1], [1, 2]],
	[[1, 0], [2, 1], [3, 2]],
	[[2, 0], [3, 0], [4, 0]],
	[[2, 0], [2, 1], [2, 2]],
	[[2, 0], [1, 1], [0, 2]],
	[[2, 0], [3, 1], [4, 2]],
	[[3, 0], [3, 1], [3, 2]],
	[[3, 0], [2, 1], [1, 2]],
	[[4, 0], [4, 1], [4, 2]],
	[[4, 0], [3, 1], [2, 2]],
	[[0, 1], [1, 1], [2, 1]],
	[[0, 1], [0, 2], [0, 3]],
	[[0, 1], [1, 2], [2, 3]],
	[[1, 1], [2, 1], [3, 1]],
	[[1, 1], [1, 2], [1, 3]],
	[[1, 1], [2, 2], [3, 3]],
	[[2, 1], [3, 1], [4, 1]],
	[[2, 1], [2, 2], [2, 3]],
	[[2, 1], [1, 2], [0, 3]],
	[[2, 1], [3, 2], [4, 3]],
	[[3, 1], [3, 2], [3, 3]],
	[[3, 1], [2, 2], [1, 3]],
	[[4, 1], [4, 2], [4, 3]],
	[[4, 1], [3, 2], [2, 3]],
	[[0, 2], [1, 2], [2, 2]],
	[[0, 2], [0, 3], [0, 4]],
	[[0, 2], [1, 3], [2, 4]],
	[[1, 2], [2, 2], [3, 2]],
	[[1, 2], [1, 3], [1, 4]],
	[[1, 2], [2, 3], [3, 4]],
	[[2, 2], [3, 2], [4, 2]],
	[[2, 2], [2, 3], [2, 4]],
	[[2, 2], [1, 3], [0, 4]],
	[[2, 2], [3, 3], [4, 4]],
	[[3, 2], [3, 3], [3, 4]],
	[[3, 2], [2, 3], [1, 4]],
	[[4, 2], [4, 3], [4, 4]],
	[[4, 2], [3, 3], [2, 4]],
	[[0, 3], [1, 3], [2, 3]],
	[[1, 3], [2, 3], [3, 3]],
	[[2, 3], [3, 3], [4, 3]],
	[[0, 4], [1, 4], [2, 4]],
	[[1, 4], [2, 4], [3, 4]],
	[[2, 4], [3, 4], [4, 4]]
];

var winning_quads = [
	[[0, 0], [1, 0], [2, 0], [3, 0]],
	[[0, 0], [0, 1], [0, 2], [0, 3]],
	[[0, 0], [1, 1], [2, 2], [3, 3]],
	[[0, 1], [1, 1], [2, 1], [3, 1]],
	[[0, 1], [0, 2], [0, 3], [0, 4]],
	[[0, 1], [1, 2], [2, 3], [3, 4]],
	[[0, 2], [1, 2], [2, 2], [3, 2]],
	[[0, 3], [1, 3], [2, 3], [3, 3]],
	[[0, 4], [1, 4], [2, 4], [3, 4]],
	[[1, 0], [2, 0], [3, 0], [4, 0]],
	[[1, 0], [1, 1], [1, 2], [1, 3]],
	[[1, 0], [2, 1], [3, 2], [4, 3]],
	[[1, 1], [2, 1], [3, 1], [4, 1]],
	[[1, 1], [1, 2], [1, 3], [1, 4]],
	[[1, 1], [2, 2], [3, 3], [4, 4]],
	[[1, 2], [2, 2], [3, 2], [4, 2]],
	[[1, 3], [2, 3], [3, 3], [4, 3]],
	[[1, 4], [2, 4], [3, 4], [4, 4]],
	[[2, 0], [2, 1], [2, 2], [2, 3]],
	[[2, 1], [2, 2], [2, 3], [2, 4]],
	[[3, 0], [3, 1], [3, 2], [3, 3]],
	[[3, 0], [2, 1], [1, 2], [0, 3]],
	[[3, 1], [3, 2], [3, 3], [3, 4]],
	[[3, 1], [2, 2], [1, 3], [0, 4]],
	[[4, 0], [4, 1], [4, 2], [4, 3]],
	[[4, 0], [3, 1], [2, 2], [1, 3]],
	[[4, 1], [4, 2], [4, 3], [4, 4]],
	[[4, 1], [3, 2], [2, 3], [1, 4]]
];

function check_winner() {
	for (var idx in winning_quads) {
		var quad = winning_quads[idx];
		var sum = board[quad[0][0]][quad[0][1]];
		sum += board[quad[1][0]][quad[1][1]];
		sum += board[quad[2][0]][quad[2][1]];
		sum += board[quad[3][0]][quad[3][1]];

		if (sum == 4 || sum == -4) {
			return [sum/4, true];
		}
	}
	for (var idx in losing_triplets) {
		var triplet = losing_triplets[idx];
		var sum = board[triplet[0][0]][triplet[0][1]];
		sum += board[triplet[1][0]][triplet[1][1]];
		sum += board[triplet[2][0]][triplet[2][1]];

		if (sum == 3 || sum == -3) {
			return [-sum/3, true];
		}
	}
	for (var idx in board) {
		for (var j in board[idx]) {
			if (board[idx][j] == 0) {
				return [0, false];
			}
		}
	}
	// Get here, all 25 spots on board filled, no winning quadruplet
	return [0, true];
}

function static_value() {
	var score = 0;
	for (var i = 0; i < 5; ++i) {
		for (var j = 0; j < 5; ++j) {
			score += board[i][j] * scores[i][j];
		}
	}
	for (var idx in winning_quads) {
		var quad = winning_quads[idx];
		var sum = board[quad[0][0]][quad[0][1]];
		sum += board[quad[1][0]][quad[1][1]];
		sum += board[quad[2][0]][quad[2][1]];
		sum += board[quad[3][0]][quad[3][1]];
		if (sum == 3 || sum == -3) {
			score += sum * 10
		}
    }
    return score

}
function resetgame() {
	board = new Array(5);
	for (var i = 0; i < 5; ++i) {
		board[i] = new Array(5);
		for (var j = 0; j < 5; ++j) {
			board[i][j] = 0;
			var nm = "td"+i+j;
			var ob = document.getElementById(nm);
			ob.innerHTML = '<input type="button" name="b'+i+j+'" onclick="clork(this, '+i+', '+j+');" />';
			ob.style.backgroundColor = 'white';
		}
	}
	move_counter = 0;
	game_over = false;
}
function cfirst() {
	mymove();
	// maybe make the "Computer First" button disappear?
}
</script>

</head>
<body>
<h1>Squava</h1>
<form name="f">
	<table border="1" class="fixed">
	<tbody>
		<tr><td valign="middle" align="center" style="height:30px;width:20%" id="td00"><input type="button" name="b00" onclick="clork(this, 0, 0);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td10"><input type="button" name="b10" onclick="clork(this, 1, 0);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td20"><input type="button" name="b20" onclick="clork(this, 2, 0);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td30"><input type="button" name="b30" onclick="clork(this, 3, 0);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td40"><input type="button" name="b40" onclick="clork(this, 4, 0);" /></td></tr>
		<tr><td valign="middle" align="center" style="height:30px;width:20%" id="td01"><input type="button" name="b01" onclick="clork(this, 0, 1);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td11"><input type="button" name="b11" onclick="clork(this, 1, 1);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td21"><input type="button" name="b21" onclick="clork(this, 2, 1);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td31"><input type="button" name="b31" onclick="clork(this, 3, 1);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td41"><input type="button" name="b41" onclick="clork(this, 4, 1);" /></td></tr>
		<tr><td valign="middle" align="center" style="height:30px;width:20%" id="td02"><input type="button" name="b02" onclick="clork(this, 0, 2);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td12"><input type="button" name="b12" onclick="clork(this, 1, 2);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td22"><input type="button" name="b22" onclick="clork(this, 2, 2);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td32"><input type="button" name="b32" onclick="clork(this, 3, 2);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td42"><input type="button" name="b42" onclick="clork(this, 4, 2);" /></td></tr>
		<tr><td valign="middle" align="center" style="height:30px;width:20%" id="td03"><input type="button" name="b03" onclick="clork(this, 0, 3);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td13"><input type="button" name="b13" onclick="clork(this, 1, 3);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td23"><input type="button" name="b23" onclick="clork(this, 2, 3);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td33"><input type="button" name="b33" onclick="clork(this, 3, 3);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td43"><input type="button" name="b43" onclick="clork(this, 4, 3);" /></td></tr>
		<tr><td valign="middle" align="center" style="height:30px;width:20%" id="td04"><input type="button" name="b04" onclick="clork(this, 0, 4);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td14"><input type="button" name="b14" onclick="clork(this, 1, 4);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td24"><input type="button" name="b24" onclick="clork(this, 2, 4);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td34"><input type="button" name="b34" onclick="clork(this, 3, 4);" /></td><td valign="middle" align="center" style="height:30px;width:20%" id="td44"><input type="button" name="b44" onclick="clork(this, 4, 4);" /></td></tr>
	</tbody>
	</table>
	<br/>
	<input type="button" name="rstbtn" value="New Game" onclick="resetgame();" />
	<br/>
	<input type="button" name="firstbtn" value="Computer First" onclick="cfirst();" />
</form>
</body>
</html>
